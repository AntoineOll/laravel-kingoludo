buildscript {
  repositories {
    maven {
      url "https://plugins.gradle.org/m2/"
    }
  }
  dependencies {
    classpath "gradle.plugin.org.swissphpfriends:php-build-plugin:0.1-SNAPSHOT"
  }
}

apply plugin: "org.hasnat.php-build-plugin"
apply plugin: "distribution"
apply plugin: "maven-publish"

def majorVersion = System.getenv("MAJOR_VERSION") ?: "1"
def minorVersion = System.getenv("MINOR_VERSION") ?: "0"
version = majorVersion + "." + minorVersion 

task purge(type:Delete) {
  //println 'Cleaning up old files'
  delete 'vendor', 'logs', 'build'
}

task installDeps(type: org.swissphpfriends.gradle.task.ComposerInstall, dependsOn: purge) {
    workingDirectory = "./"
    doNotUpdatePhar = true
}

task test(type:Exec) {
  //println 'Executing tests'
  executable 'sh'
  args '-c', "php \
    './vendor/phpunit/phpunit/phpunit' \
    --configuration='./phpunit.xml' \
    --log-junit='./logs/unitreport.xml'\
    ./project/tests"
}

task packageDistribution(type: Zip, dependsOn: test) {
    def tarfile = "application-1.0"

    archiveFileName = tarfile + ".zip"
    destinationDirectory = file("project/build")

    from ('./app') { into 'app' }
    from ('./bootstrap') { into 'bootstrap' }
    from ('./config') { into 'config' }
      from ('./database') { into 'database' }
      from ('./nbproject') { into 'nbproject' }
      from ('./public') { into 'public' }
      from ('./resources') { into 'resources' }
      from ('./storage') {
        into 'storage'
        dirMode 0775
      }
      from ('./vendor') { into 'vendor' }
      from { './server.php' }
}

group = 'laravel-kingoludo'

publishing {
    publications {
        maven(MavenPublication) {
            artifact source: packageDistribution, extension: 'zip'
        }
    }
    repositories {
        maven {
            //credentials {
            //    username nexusUsername
            //    password nexusPassword
            //}
            url nexusRepo
        }
    }
}

assemble.dependsOn packageDistribution
   build.dependsOn assemble
 publish.dependsOn build
